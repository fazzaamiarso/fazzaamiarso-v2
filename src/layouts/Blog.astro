---
import Icon from "astro-icon";
import { LikeWrapper } from "components/mdx/LikeButton";
import TOC from "components/mdx/TOC.astro";
import { prisma } from "lib/prisma";
import Layout from "./Layout.astro";

const { frontmatter, headings, url: slug } = Astro.props;
const ip = Astro.clientAddress;

// TODO: Separate layout for blog and projects
const postMeta = await prisma.post.upsert({
  where: { slug },
  select: { views: true, _count: { select: { likes: true } } },
  create: { slug },
  update: { views: { increment: 1 } },
});
---

<Layout title={frontmatter.title} desc={frontmatter.description}>
  <main class='space-y-12 pb-24'>
    <div class='bg-gray-200 pb-12 pt-24'>
      <div class='layout'>
        <a href='/' class='text-sm underline'>Home</a>
        <h1 class='mb-2 text-4xl font-bold'>{frontmatter.title}</h1>
        <p class='mb-2 text-lg'>{frontmatter.description}</p>
        <div class='mb-6 flex items-center gap-2'>
          <p class='text-sm'>
            {
              new Intl.DateTimeFormat("en-US", { dateStyle: "long" }).format(
                new Date(frontmatter.publishedAt)
              )
            }
          </p>
          -
          <p class='text-sm'>{postMeta.views} views</p>
          -
          <p class='text-sm'>{Math.round(frontmatter.minutesRead)} minutes read</p>
        </div>
        <ul class='flex items-center gap-4 empty:hidden'>
          {
            frontmatter.github && (
              <li>
                <a
                  href={frontmatter.github}
                  target='_blank'
                  referrerpolicy='strict-origin-when-cross-origin'
                  class='flex items-center gap-2'>
                  <Icon name='simple-icons:github' class='w-6' aria-hidden='true' />
                  Github
                </a>
              </li>
            )
          }
          {
            frontmatter.liveSite && (
              <li>
                <a
                  href={frontmatter.liveSite}
                  target='_blank'
                  referrerpolicy='strict-origin-when-cross-origin'
                  class='flex items-center gap-2'>
                  <Icon name='system-uicons:chain' class='w-6' aria-hidden='true' />
                  Live Site
                </a>
              </li>
            )
          }
          {
            frontmatter.demo && (
              <li>
                <a
                  href={frontmatter.demo}
                  target='_blank'
                  referrerpolicy='strict-origin-when-cross-origin'
                  class='flex items-center gap-2'>
                  <Icon name='simple-icons:youtube' class='w-6' aria-hidden='true' />
                  Demo
                </a>
              </li>
            )
          }
        </ul>
      </div>
    </div>
    <div class='layout grid grid-cols-4 gap-x-2'>
      <article
        class='blog prose col-span-3 prose-headings:scroll-mt-20 prose-code:font-code max-lg:col-span-4 md:prose-lg'>
        <slot />
      </article>
      <aside class='max-lg:hidden'>
        <div class='sticky top-20 h-[80vh] overflow-y-auto pr-4 pb-12'>
          <TOC pageHeadings={headings} />
          <div class='my-4 h-px w-full bg-black'></div>
          <div class='flex justify-between'>
            <LikeWrapper client:load slug={slug} ip={ip} initialLikes={postMeta._count.likes} />
            <button id='scroll-top' type='button' class='text-sm'>Back to top</button>
          </div>
        </div>
      </aside>
    </div>
  </main>
</Layout>

<script>
  const scrollTopButton = document.querySelector("#scroll-top") as HTMLButtonElement;
  scrollTopButton.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
</script>

<style is:global>
  .blog code {
    counter-reset: step;
    counter-increment: step 0;
  }

  .blog :not(pre) code {
    @apply rounded-sm bg-gray-200 px-1 py-[6px];
  }

  .blog pre code {
    font-size: 1rem;
  }

  .blog pre::-webkit-scrollbar {
    @apply rounded-b-md h-1 bg-gray-900;
  }
  .blog pre::-webkit-scrollbar-thumb {
    @apply rounded-full my-1 bg-gray-400;
  }

  .blog code::after,
  .blog code::before {
    content: "";
  }

  .blog code .line::before {
    content: counter(step);
    counter-increment: step;
    margin-right: 1.5rem;
  }

  .heading-group {
    position: relative;
  }
  .heading-group::before {
    position: absolute;
    content: "#";
    height: 100%;
    width: 50px;
    transform: scale(1.5);
    left: -1rem;
    opacity: 0;
    transition: all 100ms ease-in-out;
  }
  .heading-group:hover::before {
    opacity: 1;
  }
  .heading-group a {
    content: "";
    position: absolute;
    inset: 0;
  }

  .blog img {
    @apply mx-auto rounded-md;
  }

  aside > *::-webkit-scrollbar {
    width: 4px;
  }

  aside > *::-webkit-scrollbar-thumb {
    background-color: gray;
    border-radius: 12px;
  }
</style>
